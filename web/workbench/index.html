<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exception Workbench</title>
  <link rel="stylesheet" href="../styles.css">
  <script src="../components/recon-logo.js" defer></script>
</head>
<body>
  <main class="shell">
    <header class="header">
      <div class="header-topbar">
        <div class="topbar-brand">
          <recon-logo
            size="md"
            variant="auto"
            href="/workbench"
            show-label="false"
            dark-src="../assets/recon-mark-dark.svg"
            light-src="../assets/recon-mark-light.svg"
          ></recon-logo>
          <span class="topbar-title">RECON</span>
        </div>
        <div class="topbar-center" aria-label="Current workspace">
          <span class="topbar-workspace-label">Exception Workbench</span>
        </div>
        <div class="topbar-status" aria-live="polite">
          <span class="topbar-stat">Pending: <strong id="metric-exceptions-today">0</strong></span>
          <span class="topbar-stat">Needs Review: <strong id="metric-needs-review">0</strong></span>
          <span class="topbar-stat">Resolved: <strong id="metric-resolved">0</strong></span>
          <a class="header-link topbar-shortcut" id="shortcut-help-link" href="#">Keyboard shortcuts</a>
        </div>
      </div>
      <section class="daily-state-strip" aria-live="polite">
        <div class="daily-strip-title">Today's Scan</div>
        <div class="daily-strip-rule" aria-hidden="true"></div>
        <p id="daily-strip-summary" class="daily-strip-summary">0 Exceptions detected across 0 sessions</p>
        <p id="daily-strip-updated" class="daily-strip-updated">Last updated: --</p>
      </section>
      <p class="workspace-persistence-note">
        Stored locally for this workspace test.
        <span id="workspace-save-status">Saved</span>
      </p>
    </header>

    <section class="workbench-layout">
      <section class="panel queue-panel">
        <h2>Exception Queue</h2>
        <p id="queue-status" class="queue-status-text">Loading queue...</p>
        <div id="queue-alert" class="inline-banner" hidden>Backend not reachable. Start the server and retry.</div>

        <div class="queue-controls">
          <div class="field">
            <label for="queue-search">Search</label>
            <input id="queue-search" type="text" placeholder="merchant, vendor, diagnosis">
          </div>

          <div class="queue-filter-pills" id="queue-filter-pills">
            <button class="filter-pill active" type="button" data-filter="all">All</button>
            <button class="filter-pill" type="button" data-filter="probable">Probable</button>
            <button class="filter-pill" type="button" data-filter="possible">Possible</button>
            <button class="filter-pill" type="button" data-filter="no_confident">No Confident</button>
          </div>

        <div class="queue-control-row">
          <div class="field queue-sort-field">
            <label for="queue-sort">Sort</label>
            <select id="queue-sort">
              <option value="confidence_desc" selected>Confidence desc</option>
              <option value="amount_desc">Amount desc</option>
              <option value="date_desc">Date desc</option>
            </select>
          </div>

          <label class="queue-checkbox" for="show-only-unresolved">
            <input id="show-only-unresolved" type="checkbox">
            Show only unresolved
          </label>
        </div>
      </div>

        <div class="queue-table-wrap">
          <table class="queue-table" id="queue-table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Merchant</th>
                <th>Amount</th>
                <th>Diagnosis</th>
                <th>Confidence</th>
              </tr>
            </thead>
            <tbody id="queue-body">
              <tr>
                <td colspan="5" class="queue-empty">No exceptions in queue yet.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="session-controls">
          <span id="current-session-label">Session: --</span>
          <button id="clear-current-session" class="secondary" type="button" disabled>Clear Current Session</button>
        </div>

        <section class="intake-card">
          <details id="new-session-drawer" class="intake-drawer">
            <summary>New Session Intake</summary>
            <div class="intake-drawer-body">
              <form id="session-intake-form" novalidate>
                <div class="field">
                  <label for="intake-transactions-csv">Transactions CSV</label>
                  <input id="intake-transactions-csv" type="file" accept=".csv,text/csv" required>
                </div>
                <div class="field">
                  <label for="intake-receipts">Receipts (optional multiple)</label>
                  <input id="intake-receipts" type="file" accept=".png,.jpg,.jpeg,.pdf,.tiff,.tif,.bmp,.webp" multiple>
                </div>
                <button id="session-intake-submit" class="primary button-inline-primary" type="submit">Populate Workbench</button>
                <p id="session-intake-status" class="status intake-status"></p>
                <p class="help intake-help">Runs diagnostic analysis and adds only mismatches to the workbench.</p>
                <p class="security-inline">Read-only analysis | No data stored</p>
              </form>
              <button id="single-diagnosis-toggle" class="link-button intake-inline-link" type="button" aria-expanded="false" aria-controls="single-diagnosis-panel">
                Single diagnosis mode
              </button>
              <section id="single-diagnosis-panel" class="single-diagnosis-panel" hidden>
                <form id="single-diagnosis-form" novalidate>
                  <div class="field">
                    <label for="single-receipt-file">Receipt upload</label>
                    <input id="single-receipt-file" type="file" accept=".png,.jpg,.jpeg,.pdf,.tiff,.tif,.bmp,.webp" required>
                  </div>
                  <div class="field">
                    <label for="single-csv-file">Transactions CSV</label>
                    <input id="single-csv-file" type="file" accept=".csv,text/csv" required>
                    <p class="help">Expected: merchant, date, amount</p>
                  </div>
                  <button id="single-diagnosis-submit" class="secondary button-inline-primary" type="submit">Run Single Diagnosis</button>
                  <p id="single-diagnosis-status" class="status intake-status"></p>
                  <button id="single-advanced-toggle" class="link-button intake-inline-link" type="button" aria-expanded="false" aria-controls="single-advanced-fields">Advanced</button>
                  <div id="single-advanced-fields" class="advanced single-advanced-fields" hidden>
                    <div class="field">
                      <label for="single-manual-vendor">manual_vendor</label>
                      <input id="single-manual-vendor" type="text" autocomplete="off" placeholder="Override vendor">
                    </div>
                    <div class="field">
                      <label for="single-manual-date">manual_date</label>
                      <input id="single-manual-date" type="text" autocomplete="off" placeholder="Override date (YYYY-MM-DD)">
                    </div>
                    <div class="field">
                      <label for="single-manual-total">manual_total</label>
                      <input id="single-manual-total" type="text" autocomplete="off" placeholder="Override total (e.g. 47.50)">
                    </div>
                  </div>
                </form>
              </section>
            </div>
          </details>
        </section>
      </section>

      <section class="panel detail-panel">
        <div id="detail-empty" class="detail-empty">
          Select a case to begin investigation.
        </div>

        <section id="detail-view" hidden>
          <div class="detail-sticky-header">
            <div class="detail-sticky-main">
              <span class="badge badge-neutral" id="detail-match-state">--</span>
              <span class="status-confidence" id="detail-confidence">--%</span>
              <span class="detail-diagnosis-label" id="detail-diagnosis">Diagnosis details</span>
              <span id="detail-known-alias-badge" class="memory-badge" hidden>Known alias (from prior review)</span>
            </div>
            <p id="detail-pattern-hint" class="pattern-hint" hidden></p>
          </div>

          <section class="subsection detail-after-sticky diagnosis-summary-band" id="detail-summary-section">
            <h3>Diagnosis Statement</h3>
            <p id="detail-summary" class="detail-summary-text">Summary will appear here.</p>
            <p id="detail-next-checks" class="detail-next-checks">Next checks: --</p>
          </section>

          <section class="subsection evidence-bridge-section" id="detail-evidence-bridge-section">
            <h3>Evidence Bridge</h3>
            <div class="evidence-bridge-grid">
              <div class="evidence-bridge-column">
                <h4>OCR Receipt Data</h4>
                <dl class="bridge-kv">
                  <div class="bridge-row" id="detail-bridge-row-merchant">
                    <dt>merchant</dt>
                    <dd id="detail-bridge-receipt-merchant">--</dd>
                  </div>
                  <div class="bridge-row" id="detail-bridge-row-amount">
                    <dt>amount</dt>
                    <dd id="detail-bridge-receipt-amount">--</dd>
                  </div>
                  <div class="bridge-row" id="detail-bridge-row-date">
                    <dt>date</dt>
                    <dd id="detail-bridge-receipt-date">--</dd>
                  </div>
                </dl>
              </div>
              <div class="evidence-bridge-column">
                <h4>Bank Transaction Data</h4>
                <dl class="bridge-kv">
                  <div class="bridge-row" id="detail-bridge-row-merchant-bank">
                    <dt>merchant</dt>
                    <dd id="detail-bridge-bank-merchant">--</dd>
                  </div>
                  <div class="bridge-row" id="detail-bridge-row-amount-bank">
                    <dt>amount</dt>
                    <dd id="detail-bridge-bank-amount">--</dd>
                  </div>
                  <div class="bridge-row" id="detail-bridge-row-date-bank">
                    <dt>date</dt>
                    <dd id="detail-bridge-bank-date">--</dd>
                  </div>
                </dl>
              </div>
            </div>
            <p class="bridge-note">Amber highlights mark fields with meaningful variance.</p>
          </section>

          <section class="subsection" id="detail-evidence-section">
            <h3>Evidence</h3>
            <ul class="evidence-list" id="detail-evidence"></ul>
          </section>

          <section class="subsection" id="detail-candidate-section">
            <h3>Top Candidate</h3>
            <div class="candidate-card">
              <dl class="top-candidate">
                <dt>merchant</dt><dd id="detail-merchant">--</dd>
                <dt>amount</dt><dd id="detail-amount">--</dd>
                <dt>date</dt><dd id="detail-date">--</dd>
                <dt>transaction_id</dt><dd id="detail-transaction-id">--</dd>
                <dt>description</dt><dd id="detail-description">--</dd>
                <dt>vendor_similarity_score</dt><dd id="detail-vendor-score">--</dd>
                <dt>amount_delta_pct</dt><dd id="detail-amount-pct">--</dd>
                <dt>date_delta_days</dt><dd id="detail-date-days">--</dd>
              </dl>
            </div>
          </section>

          <details class="subsection collapsed" id="detail-other-candidates">
            <summary>Other candidates</summary>
            <div id="detail-other-candidate-list">
              <div class="candidate-card empty-card">No additional candidates above threshold.</div>
            </div>
          </details>

          <section class="subsection" id="detail-evidence-viewer-section">
            <h3>Evidence Viewer</h3>
            <div class="row-between evidence-viewer-head">
              <h4>Receipt preview</h4>
              <label class="inline-toggle" for="detail-grounding-toggle">
                <input id="detail-grounding-toggle" type="checkbox" checked>
                Show grounding
              </label>
            </div>
            <div class="grounding-fields" id="detail-grounding-fields">
              <button class="field-pill" data-field="vendor" type="button">Vendor</button>
              <button class="field-pill" data-field="date" type="button">Date</button>
              <button class="field-pill" data-field="total" type="button">Total</button>
            </div>
            <div class="viewer-message" id="detail-grounding-message">Grounding not available for this extraction.</div>
            <div id="detail-receipt-viewer-container" class="receipt-viewer detail-receipt-viewer no-image">
              <div class="viewer-stage" id="detail-viewer-stage">
                <img id="detail-receipt-preview-image" alt="Receipt preview" hidden>
                <div id="detail-overlay-layer" class="overlay-layer"></div>
              </div>
            </div>
          </section>

          <section id="detail-alias-memory-section" class="subsection" hidden>
            <details class="alias-memory-details">
              <summary>Alias Memory</summary>
              <p id="detail-alias-memory-text" class="alias-memory-text"></p>
            </details>
          </section>

          <section class="subsection audit-note-section" id="detail-audit-section">
            <h3>Audit Note</h3>
            <textarea id="detail-audit-note" rows="8" readonly></textarea>
            <div class="row-actions">
              <button id="detail-audit-copy-summary" class="secondary" type="button">Copy summary</button>
              <button id="detail-download-json" class="secondary" type="button">Download JSON</button>
            </div>
          </section>

          <section class="subsection">
            <h3>Decision Note</h3>
            <label class="decision-note-label" for="detail-decision-note">Decision note (optional)</label>
            <textarea id="detail-decision-note" rows="4" placeholder="Add review context for this exception"></textarea>
          </section>

          <section class="subsection" id="detail-action-zone">
            <h3>Resolution</h3>
            <div class="detail-sticky-actions detail-action-buttons">
              <button id="back-to-workbench" class="secondary" type="button">&larr; Back</button>
              <button id="prev-item" class="secondary" type="button">Previous</button>
              <button id="next-item" class="secondary" type="button">Next</button>
              <button id="detail-copy-summary" class="primary button-inline-primary" type="button">Copy Audit Memo</button>
              <button id="detail-copy-next" class="secondary" type="button">Copy Memo + Next</button>
            </div>
            <div class="detail-resolution-row">
              <p class="resolution-guidance">Mark your decision. This does not change accounting records.</p>
              <div class="resolution-footer" aria-label="Resolution footer actions">
                <button id="detail-resolve-ignore" class="secondary resolution-footer-btn" type="button" data-resolution="ignored">Ignore</button>
                <button id="detail-resolve-flag" class="secondary resolution-footer-btn" type="button" data-resolution="follow_up">Flag</button>
                <button id="detail-resolve-accept" class="primary resolution-footer-btn resolution-footer-primary" type="button" data-resolution="accepted">Accept Match</button>
              </div>
              <fieldset class="resolution-options" id="detail-resolution-options" aria-label="Resolution">
                <label class="resolution-pill">
                  <input type="radio" name="detail-resolution" value="accepted">
                  <span>Accept Match</span>
                </label>
                <label class="resolution-pill">
                  <input type="radio" name="detail-resolution" value="ignored">
                  <span>Ignore</span>
                </label>
                <label class="resolution-pill">
                  <input type="radio" name="detail-resolution" value="follow_up">
                  <span>Needs Follow-up</span>
                </label>
              </fieldset>
              <div class="detail-resolution-actions">
                <span id="detail-resolution-state" class="resolution-state">Resolution: Unreviewed</span>
                <button id="detail-resolution-clear" class="secondary" type="button">Reset</button>
              </div>
            </div>
          </section>
        </section>
      </section>
    </section>
  </main>

  <div class="shortcut-modal" id="shortcut-modal" hidden>
    <div class="shortcut-modal-card" role="dialog" aria-modal="true" aria-labelledby="shortcut-modal-title">
      <h2 id="shortcut-modal-title">Keyboard Shortcuts</h2>
      <div class="shortcut-grid">
        <div class="shortcut-col">
          <h3>List View</h3>
          <p><kbd>J</kbd> Move down</p>
          <p><kbd>K</kbd> Move up</p>
          <p><kbd>Enter</kbd> Open selected</p>
          <p><kbd>/</kbd> Focus search</p>
          <p><kbd>Esc</kbd> Clear search focus</p>
        </div>
        <div class="shortcut-col">
          <h3>Detail View</h3>
          <p><kbd>J</kbd> Next item</p>
          <p><kbd>K</kbd> Previous item</p>
          <p><kbd>C</kbd> Copy audit memo</p>
          <p><kbd>Shift+C</kbd> Copy memo + next</p>
          <p><kbd>Esc</kbd> Back to list</p>
        </div>
      </div>
      <div class="row-actions">
        <button id="shortcut-modal-close" class="secondary" type="button">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" hidden></div>

  <script src="./workbench_logic.js"></script>
  <script src="./decision_state.js"></script>
  <script src="./memory_state.js"></script>
  <script src="./workspace_sync.js"></script>
  <script src="./workbench.js"></script>
</body>
</html>
